<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns="http://www.springframework.org/schema/webflow"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

    <input name="order" required="true" type="jpa.Order"/>

    <view-state id="showOrder" view="showOrder">
        <transition on="newLine" to="newLine"/>
        <transition on="checkOut" to="orderCreated"/>
        <transition on="cancel" to="cancel"/>
    </view-state>

    <view-state id="itemQuantitySelect" view="itemQuantitySelect">
        <transition on="submitLine" to="newLine"/>
    </view-state>

    <action-state id="newLine">
        <on-entry>
            <set name="flowScope.line" value="new jpa.OrderLine()"/>
            <set name="flowScope.line.order" value="order"/>
            <set name="flowScope.line.lineNumber" value="order.orderLines.size() + 1"/>
            <set name="flowScope.line.item" value="orderService.findItem(requestParameters.code)"/>
            <set name="flowScope.line.orderedQuantity" value="orderService.checkQuantity(requestParameters.quantity)"/>
            <set name="flowScope.line.pendingQuantity" value="flowScope.line.orderedQuantity"/>
        </on-entry>
        <transition on-exception="services.utils.orders.ItemNotFoundException" to="itemQuantitySelect"/>
        <transition on-exception="services.utils.orders.NegativeQuantityException" to="itemQuantitySelect"/>
        <transition to="showOrder">
            <evaluate expression="order.orderLines.add(flowScope.line)"/>
        </transition>
    </action-state>

    <end-state id="cancel"/>
    <end-state id="orderCreated"/>
</flow>